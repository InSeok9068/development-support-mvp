# SPEC.md

## 추천 플로우

1. 사용자가 로그인/회원가입을 한다.

2. 사용자는 이미지를 직접 올리거나, 이미지 URL 링크를 통해 이미지를 업로드 시킨다.

3. 서버는 업로드 요청을 받으면 **옷 아이템 레코드를 먼저 생성**하고, 해당 레코드의 처리 상태를 `uploaded`로 저장한다.
   - 이 시점에 사용자는 옷장 UI에서 “분석 중” 상태로 확인할 수 있다.

4. 서버는 백그라운드 작업으로 이미지 전처리를 수행하고, 분석용 이미지와 썸네일 이미지를 만들어낸다.
   - 전처리 시작 시 상태값을 `preprocessing`으로 변경한다.
   - 전처리 실패 시 상태값을 `failed`로 변경하고 실패 사유 코드를 저장한다. (예: `image_decode_error`)

5. 전처리가 완료되면 서버는 분석용 이미지를 AI(Gemini)에 요청하여 아래의 정보를 추출한다.
   - 요청 시작 시 상태값을 `analyzing`으로 변경한다.
   - 카테고리(category): 상의,하의,신발,악세사리(모자,시계 등..)
   - 계절(season): 봄,여름,가을,겨울 (복수선택 가능)
   - 색깔(color): 빨강,파랑,노랑 등
   - 스타일(style): 스트릿, 캐주얼, 클래식 등
   - 핏(fit): 오버핏, 슬림핏, 와이드핏, 루즈핏
   - 소재(material): 면, 니트, 가죽
   - 상황(context): 출근, 결혼식
   - AI 응답이 지연/실패할 수 있으므로 실패 시 `failed`로 변경하고 실패 사유 코드를 저장한다. (예: `ai_timeout`, `ai_invalid_json`)

6. 이미지 해싱 + 추출한 정보를 토대로 AI에게 임베딩을 요청한다.
   - 요청 시작 시 상태값을 `embedding`으로 변경한다.
   - 실패 시 `failed`로 변경하고 실패 사유 코드를 저장한다.

7. 데이터베이스에 다음 정보를 저장한다.
   - 분석용 이미지, 썸네일 이미지, 이미지 해싱값, 분석정보, 임베딩 결과
   - 모든 단계가 성공하면 상태값을 `done`으로 변경한다.

8. 이미지 분석이 완료되면 사용자에게 알려주고(또는 다음 접속 시), 사용자의 옷장 UI에 갱신한다.
   - `done` 상태인 아이템은 정상 노출
   - `failed` 상태인 아이템은 실패 안내(재시도 버튼 제공 가능)

9. 사용자는 자연어로 원하는 스타일을 말하고 서버는 AI를 활용해 해당 자연어를 DB가 해석할 수 있는 JSON 응답으로 변환한다.

10. DB 쿼리 필터를 통해 후보군을 추출한다.

11. 아래 로직으로 후보군 중 순위가 높은 것들을 추출한다.
    - queryText → 임베딩 벡터(q)
    - 각 옷 레코드의 embedding 벡터(e)
    - 유사도 = cosine(q, e)
    - 유사도 높은 순으로 정렬 topK

12. 사용자는 추천된 스타일을 본다.

13. 사용자는 각각 카테고리별로 맘에 드는 스타일은 고정할 수 있으며, 재추천을 통해 고정되지 않은 카테고리에 대해 후순위 데이터로 다시 추천을 받을 수 있다.

14. 사용자는 최종 스타일 컨펌을 통해 해당 일자에 해당 스타일을 입었다는 로그를 기록한다.

15. 사용자가 자주 선택하는 옷에 대해서는 자연스럽게 해당 옷 정보에 선호도가 증가한다.

## 처리 상태 및 실패/재시도 규칙

- 상태값(state)
  - `uploaded`: 업로드 요청을 받아 레코드를 만든 상태
  - `preprocessing`: 썸네일/분석용 이미지 생성 중
  - `analyzing`: Gemini로 속성 추출 중
  - `embedding`: 임베딩 생성 중
  - `done`: 모든 처리 완료
  - `failed`: 처리 실패

- 실패 사유 코드(error_code) 예시
  - `image_decode_error`: 이미지 디코딩/포맷 문제
  - `ai_timeout`: AI 응답 지연/타임아웃
  - `ai_invalid_json`: AI 응답이 스키마(JSON) 요구사항 불일치
  - `embedding_error`: 임베딩 요청 실패

- 재시도(retry)
  - 단계별 재시도 횟수 `retry_count`를 저장하고, 최대 재시도 `max_retry`를 초과하면 `failed`로 확정한다.
  - 재시도는 동일 단계에서만 수행하거나, 필요 시 전처리부터 재수행한다(정책으로 결정).

## 옷장관리

1. 사용자는 옷장에 있는 옷을 볼 수 있으며 검색/필터링이 가능하다.
   - `uploaded/preprocessing/analyzing/embedding` 상태는 “분석 중”으로 표시한다.
   - `failed` 상태는 실패 사유를 표시하고 재시도 UI를 제공할 수 있다.

2. 옷장에 있는 옷을 클릭하면 상세정보를 볼 수 있고 직접 수정 가능하다(선호도 초기화도 가능).
   - 사용자가 분석정보를 수정하면 필요 시 임베딩을 다시 수행한다.

3. 사용자가 수정하면 수정한 데이터를 저장하고, 정책에 따라 임베딩을 다시 수행한다.
